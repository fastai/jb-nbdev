
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transforms &#8212; fastcore docs</title>
    
  <link rel="stylesheet" href="_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://fastai.github.io/jb-fastcore/05_transform.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />


<!-- Opengraph tags -->
<meta property="og:url"         content="https://fastai.github.io/jb-fastcore/05_transform.html" />
<meta property="og:type"        content="article" />
<meta property="og:title"       content="Transforms" />
<meta property="og:description" content="Transforms  Definition of Transform and Pipeline  The classes here provide functionality for creating a composition of partially reversible functions. By “parti" />
<meta property="og:image"       content="https://fastai.github.io/jb-fastcore/_static/logo.png" />

<meta name="twitter:card" content="summary" />


  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  <img src="_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">fastcore docs</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="index.html">
   Welcome to fastcore
  </a>
 </li>
</ul>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="00_test.html">
   Test
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="01_basics.html">
   Basic functionality
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="01_basics.html#export">
   Export -
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/05_transform.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/fastai/jb-fastcore/master?urlpath=tree/docs/05_transform.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#transform">
   Transform -
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#the-main-transform-features">
     The main
     <code class="docutils literal notranslate">
      <span class="pre">
       Transform
      </span>
     </code>
     features:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#defining-a-transform">
     Defining a
     <code class="docutils literal notranslate">
      <span class="pre">
       Transform
      </span>
     </code>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#defining-transforms-with-a-decorator">
       Defining Transforms With A Decorator
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#typed-dispatch-and-transforms">
       Typed Dispatch and Transforms
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#casting-types-with-transform">
       Casting Types With Transform
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#apply-transforms-on-subsets-with-split-idx">
       Apply Transforms On Subsets With
       <code class="docutils literal notranslate">
        <span class="pre">
         split_idx
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#transforms-on-lists">
       Transforms on Lists
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#transforms-on-tuples">
       Transforms on Tuples
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#itemtransform">
       ItemTransform -
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#func">
     Func -
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pipeline">
   Pipeline -
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#methods">
     Methods
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#export">
   Export -
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#default_exp transform</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="kn">from</span> <span class="nn">fastcore.imports</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastcore.foundation</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastcore.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastcore.dispatch</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">inspect</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.showdoc</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastcore.test</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">fastcore.nb_imports</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="transforms">
<h1>Transforms<a class="headerlink" href="#transforms" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>Definition of <code class="docutils literal notranslate"><span class="pre">Transform</span></code> and <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></p>
</div></blockquote>
<p>The classes here provide functionality for creating a composition of <em>partially reversible functions</em>. By “partially reversible” we mean that a transform can be <code class="docutils literal notranslate"><span class="pre">decode</span></code>d, creating a form suitable for display. This is not necessarily identical to the original form (e.g. a transform that changes a byte tensor to a float tensor does not recreate a byte tensor when decoded, since that may lose precision, and a float tensor can be displayed already).</p>
<p>Classes are also provided and for composing transforms, and mapping them over collections. <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> is a transform which composes several <code class="docutils literal notranslate"><span class="pre">Transform</span></code>, knowing how to decode them or show an encoded item.</p>
<div class="section" id="transform">
<h2>Transform -<a class="headerlink" href="#transform" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="n">_tfm_methods</span> <span class="o">=</span> <span class="s1">&#39;encodes&#39;</span><span class="p">,</span><span class="s1">&#39;decodes&#39;</span><span class="p">,</span><span class="s1">&#39;setups&#39;</span>

<span class="k">class</span> <span class="nc">_TfmDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_tfm_methods</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">v</span><span class="p">):</span> <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">TypeDispatch</span><span class="p">())</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">class</span> <span class="nc">_TfmMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">_tfm_methods</span><span class="p">:</span>
            <span class="n">base_td</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">nm</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span><span class="o">.</span><span class="n">bases</span> <span class="o">=</span> <span class="n">base_td</span>
            <span class="k">else</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">TypeDispatch</span><span class="p">(</span><span class="n">bases</span><span class="o">=</span><span class="n">base_td</span><span class="p">))</span>
        <span class="n">res</span><span class="o">.</span><span class="n">__signature__</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;__name__&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">_tfm_methods</span><span class="p">:</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="fm">__prepare__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">):</span> <span class="k">return</span> <span class="n">_TfmDict</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">def</span> <span class="nf">_get_name</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="s1">&#39;__qualname__&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="vm">__qualname__</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="s1">&#39;__name__&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">def</span> <span class="nf">_is_tuple</span><span class="p">(</span><span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;_fields&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">class</span> <span class="nc">Transform</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">_TfmMeta</span><span class="p">):</span>
    <span class="s2">&quot;Delegates (`__call__`,`decode`,`setup`) to (&lt;code&gt;encodes&lt;/code&gt;,&lt;code&gt;decodes&lt;/code&gt;,&lt;code&gt;setups&lt;/code&gt;) if `split_idx` matches&quot;</span>
    <span class="n">split_idx</span><span class="p">,</span><span class="n">init_enc</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">train_setup</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">None</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_idx</span> <span class="o">=</span> <span class="n">ifnone</span><span class="p">(</span><span class="n">split_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="o">=</span><span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_enc</span> <span class="o">=</span> <span class="n">enc</span> <span class="ow">or</span> <span class="n">dec</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_enc</span><span class="p">:</span> <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encodes</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">decodes</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">setups</span> <span class="o">=</span> <span class="n">TypeDispatch</span><span class="p">(),</span><span class="n">TypeDispatch</span><span class="p">(),</span><span class="n">TypeDispatch</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">enc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span><span class="s1">&#39;order&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">type_hints</span><span class="p">(</span><span class="n">enc</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_types</span> <span class="o">=</span> <span class="n">first</span><span class="p">(</span><span class="n">type_hints</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">_get_name</span><span class="p">(</span><span class="n">enc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dec</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_name&#39;</span><span class="p">,</span> <span class="n">_get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="s1">&#39;encodes&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decode</span>  <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="s1">&#39;decodes&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">encodes: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">encodes</span><span class="si">}</span><span class="s1">decodes: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">decodes</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train_setup</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">train_setup</span> <span class="o">=</span> <span class="n">train_setup</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_setup</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_setup</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">setups</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span> <span class="k">if</span> <span class="n">train_setup</span> <span class="k">else</span> <span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">split_idx</span><span class="o">!=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_idx</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_call</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_tuple</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;returns&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">retain_type</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_do_call</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retain_type</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="n">add_docs</span><span class="p">(</span><span class="n">Transform</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="s2">&quot;Delegate to &lt;code&gt;decodes&lt;/code&gt; to undo transform&quot;</span><span class="p">,</span> <span class="n">setup</span><span class="o">=</span><span class="s2">&quot;Delegate to &lt;code&gt;setups&lt;/code&gt; to set up transform&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">show_doc</span><span class="p">(</span><span class="n">Transform</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<h2 id="Transform" class="doc_header"><code>class</code> <code>Transform</code><a href="" class="source_link" style="float:right">[source]</a></h2>
<blockquote>
<div><p><code>Transform</code>(<strong><code class="docutils literal notranslate"><span class="pre">enc</span></code></strong>=<em><code class="docutils literal notranslate"><span class="pre">None</span></code></em>, <strong><code class="docutils literal notranslate"><span class="pre">dec</span></code></strong>=<em><code class="docutils literal notranslate"><span class="pre">None</span></code></em>, <strong><code class="docutils literal notranslate"><span class="pre">split_idx</span></code></strong>=<em><code class="docutils literal notranslate"><span class="pre">None</span></code></em>, <strong><code class="docutils literal notranslate"><span class="pre">order</span></code></strong>=<em><code class="docutils literal notranslate"><span class="pre">None</span></code></em>)</p>
</div></blockquote>
<p>Delegates (<code class="docutils literal notranslate"><span class="pre">__call__</span></code>,<code class="docutils literal notranslate"><span class="pre">decode</span></code>,<code class="docutils literal notranslate"><span class="pre">setup</span></code>) to (<code>encodes</code>,<code>decodes</code>,<code>setups</code>) if <code class="docutils literal notranslate"><span class="pre">split_idx</span></code> matches</p>
</div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">Transform</span></code> is the main building block of the fastai data pipelines. In the most general terms a transform can be any function you want to apply to your data, however the <code class="docutils literal notranslate"><span class="pre">Transform</span></code> class provides several mechanisms that make the process of building them easy and flexible.</p>
<div class="section" id="the-main-transform-features">
<h3>The main <code class="docutils literal notranslate"><span class="pre">Transform</span></code> features:<a class="headerlink" href="#the-main-transform-features" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><strong>Type dispatch</strong> - Type annotations are used to determine if a transform should be applied to the given argument. It also gives an option to provide several implementations and it choses the one to run based on the type. This is useful for example when running both independent and dependent variables through the pipeline where some transforms only make sense for one and not the other. Another usecase is designing a transform that handles different data formats. Note that if a transform takes multiple arguments only the type of the first one is used for dispatch.</p></li>
<li><p><strong>Handling of tuples</strong> - When a tuple (or a subclass of tuple) of data is passed to a transform it will get applied to each element separately. You can opt out of this behavior by passing a list or an <code class="docutils literal notranslate"><span class="pre">L</span></code>, as only tuples gets this specific behavior. An alternative is to use <code class="docutils literal notranslate"><span class="pre">ItemTransform</span></code> defined below, which will always take the input as a whole.</p></li>
<li><p><strong>Reversability</strong> - A transform can be made reversible by implementing the <code>decodes</code> method. This is mainly used to turn something like a category which is encoded as a number back into a label understandable by humans for showing purposes. Like the regular call method, the <code class="docutils literal notranslate"><span class="pre">decode</span></code> method that is used to decode will be applied over each element of a tuple separately.</p></li>
<li><p><strong>Type propagation</strong> - Whenever possible a transform tries to return data of the same type it received. Mainly used to maintain semantics of things like <code class="docutils literal notranslate"><span class="pre">ArrayImage</span></code> which is a thin wrapper of pytorch’s <code class="docutils literal notranslate"><span class="pre">Tensor</span></code>. You can opt out of this behavior by adding <code class="docutils literal notranslate"><span class="pre">-&gt;None</span></code> return type annotation.</p></li>
<li><p><strong>Preprocessing</strong> - The <code class="docutils literal notranslate"><span class="pre">setup</span></code> method can be used to perform any one-time calculations to be later used by the transform, for example generating a vocabulary to encode categorical data.</p></li>
<li><p><strong>Filtering based on the dataset type</strong> - By setting the <code class="docutils literal notranslate"><span class="pre">split_idx</span></code> flag you can make the transform be used only in a specific <code class="docutils literal notranslate"><span class="pre">DataSource</span></code> subset like in training, but not validation.</p></li>
<li><p><strong>Ordering</strong> - You can set the <code class="docutils literal notranslate"><span class="pre">order</span></code> attribute which the <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> uses when it needs to merge two lists of transforms.</p></li>
<li><p><strong>Appending new behavior with decorators</strong> - You can easily extend an existing <code class="docutils literal notranslate"><span class="pre">Transform</span></code> by creating <code>encodes</code> or <code>decodes</code> methods for new data types. You can put those new methods outside the original transform definition and decorate them with the class you wish them patched into. This can be used by the fastai library users to add their own behavior, or multiple modules contributing to the same transform.</p></li>
</ul>
</div>
<div class="section" id="defining-a-transform">
<h3>Defining a <code class="docutils literal notranslate"><span class="pre">Transform</span></code><a class="headerlink" href="#defining-a-transform" title="Permalink to this headline">¶</a></h3>
<p>There are a few ways to create a transform with different ratios of simplicity to flexibility.</p>
<ul class="simple">
<li><p><strong>Extending the <code class="docutils literal notranslate"><span class="pre">Transform</span></code> class</strong> - Use inheritence to implement the methods you want.</p></li>
<li><p><strong>Passing methods to the constructor</strong> - Instantiate the <code class="docutils literal notranslate"><span class="pre">Transform</span></code> class and pass your functions as <code class="docutils literal notranslate"><span class="pre">enc</span></code> and <code class="docutils literal notranslate"><span class="pre">dec</span></code> arguments.</p></li>
<li><p><strong>&#64;Transform decorator</strong> - Turn any function into a <code class="docutils literal notranslate"><span class="pre">Transform</span></code> by just adding a decorator - very straightforward if all you need is a single <code>encodes</code> implementation.</p></li>
<li><p><strong>Passing a function to fastai APIs</strong> - Same as above, but when passing a function to other transform aware classes like <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> or <code class="docutils literal notranslate"><span class="pre">TfmdDS</span></code> you don’t even need a decorator. Your function will get converted to a <code class="docutils literal notranslate"><span class="pre">Transform</span></code> automatically.</p></li>
</ul>
<p>A simple way to create a <code class="docutils literal notranslate"><span class="pre">Transform</span></code> is to pass a function to the constructor.  In the below example, we pass an anonymous function that does integer division by 2:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span><span class="n">o</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If you call this transform, it will apply the transformation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Another way to define a Transform is to extend the <code class="docutils literal notranslate"><span class="pre">Transform</span></code> class:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span> <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<p>However, to enable your transform to do something, you have to define an <code>encodes</code> method.  Note that we can use the class name as a decorator to add this method to the original class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@A</span>
<span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span>

<span class="n">f1</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f1</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># f1(1) is the same as f1.encode(1)</span>
</pre></div>
</div>
</div>
</div>
<p>In addition to adding an <code>encodes</code> method, we can also add a <code>decodes</code> method.  This enables you to call the <code class="docutils literal notranslate"><span class="pre">decode</span></code> method (without an s).  For more information about the purpose of <code>decodes</code>, see the discussion about Reversibility in <a class="reference external" href="#The-main-Transform-features">the above section</a>.</p>
<p>Just like with encodes, you can add a <code>decodes</code> method to the original class by using the class name as a decorator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">A</span><span class="p">):</span> <span class="k">pass</span>

<span class="nd">@B</span>
<span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span>

<span class="n">f2</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f2</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">f2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># uses A&#39;s encode method from the parent class</span>
</pre></div>
</div>
</div>
</div>
<p>If you do not define an <code>encodes</code> or <code>decodes</code> method the original value will be returned:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_Tst</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span> <span class="k">pass</span> 

<span class="n">f3</span> <span class="o">=</span> <span class="n">_Tst</span><span class="p">()</span> <span class="c1"># no encodes or decodes method have been defined</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f3</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="mf">2.0</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f3</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="defining-transforms-with-a-decorator">
<h4>Defining Transforms With A Decorator<a class="headerlink" href="#defining-transforms-with-a-decorator" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Transform</span></code> can be used as a decorator to turn a function into a <code class="docutils literal notranslate"><span class="pre">Transform</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Transform</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">//</span><span class="mi">2</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="mf">2.0</span><span class="p">)</span>

<span class="nd">@Transform</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="mf">2.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="typed-dispatch-and-transforms">
<h4>Typed Dispatch and Transforms<a class="headerlink" href="#typed-dispatch-and-transforms" title="Permalink to this headline">¶</a></h4>
<p>We can also apply different transformations depending on the type of the input passed by using <code class="docutils literal notranslate"><span class="pre">TypedDispatch</span></code>.  <code class="docutils literal notranslate"><span class="pre">TypedDispatch</span></code> automatically works with <code class="docutils literal notranslate"><span class="pre">Transform</span></code> when using type hints:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span> <span class="k">pass</span>

<span class="nd">@A</span>
<span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">//</span><span class="mi">2</span>

<span class="nd">@A</span>
<span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">float</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>When we pass in an <code class="docutils literal notranslate"><span class="pre">int</span></code>, this calls the first encodes method:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When we pass in a <code class="docutils literal notranslate"><span class="pre">float</span></code>, this calls the second encodes method:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mf">2.</span><span class="p">),</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When we pass in a type that is not specified in <code>encodes</code>, the original value is returned:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If the type annotation is a tuple, then any type in the tuple will match:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:(</span><span class="n">MyClass</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span> <span class="k">return</span> <span class="n">x</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:(</span><span class="nb">str</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_1&#39;</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The below two examples match the first encodes, with a type of <code class="docutils literal notranslate"><span class="pre">MyClass</span></code> and <code class="docutils literal notranslate"><span class="pre">float</span></code>, respectively:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">MyClass</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="mf">1.</span><span class="p">)</span> <span class="c1"># input is of type MyClass </span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mf">6.0</span><span class="p">),</span> <span class="mf">3.0</span><span class="p">)</span> <span class="c1"># input is of type float</span>
</pre></div>
</div>
</div>
</div>
<p>The next two examples match the second <code class="docutils literal notranslate"><span class="pre">encodes</span></code> method, with a type of <code class="docutils literal notranslate"><span class="pre">str</span></code> and <code class="docutils literal notranslate"><span class="pre">list</span></code>, respectively:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="s1">&#39;a_1&#39;</span><span class="p">)</span> <span class="c1"># input is of type str</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">]),</span> <span class="s2">&quot;[&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]_1&quot;</span><span class="p">)</span> <span class="c1"># input is of type list</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="casting-types-with-transform">
<h4>Casting Types With Transform<a class="headerlink" href="#casting-types-with-transform" title="Permalink to this headline">¶</a></h4>
<p>Without any intervention it is easy for operations to change types in Python. For example, <code class="docutils literal notranslate"><span class="pre">FloatSubclass</span></code> (defined below) becomes a <code class="docutils literal notranslate"><span class="pre">float</span></code> after performing multiplication:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FloatSubclass</span><span class="p">(</span><span class="nb">float</span><span class="p">):</span> <span class="k">pass</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">FloatSubclass</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This behavior is often not desirable when performing transformations on data.  Therefore, <code class="docutils literal notranslate"><span class="pre">Transform</span></code> will attempt to cast the output to be of the same type as the input by default.  In the below example, the output will be cast to a <code class="docutils literal notranslate"><span class="pre">FloatSubclass</span></code> type to match the type of the input:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Transform</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span>

<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">FloatSubclass</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)),</span> <span class="n">FloatSubclass</span><span class="p">(</span><span class="mf">6.0</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We can optionally turn off casting by annotating the transform function with a return type of <code class="docutils literal notranslate"><span class="pre">None</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Transform</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span> <span class="c1"># Same transform as above, but with a -&gt; None annotation</span>

<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">FloatSubclass</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)),</span> <span class="mf">6.0</span><span class="p">)</span>  <span class="c1"># Casting is turned off because of -&gt; None annotation</span>
</pre></div>
</div>
</div>
</div>
<p>However, <code class="docutils literal notranslate"><span class="pre">Transform</span></code> will only cast output back to the input type when the input is a subclass of the output.  In the below example, the input is of type <code class="docutils literal notranslate"><span class="pre">FloatSubclass</span></code> which is not a subclass of the output which is of type <code class="docutils literal notranslate"><span class="pre">str</span></code>.  Therefore, the output doesn’t get cast back to <code class="docutils literal notranslate"><span class="pre">FloatSubclass</span></code> and stays as type <code class="docutils literal notranslate"><span class="pre">str</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Transform</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">Float</span><span class="p">(</span><span class="mf">2.</span><span class="p">)),</span> <span class="s1">&#39;2.0&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Just like <code>encodes</code>, the <code>decodes</code> method will cast outputs to match the input type in the same way.  In the below example, the output of <code>decodes</code> remains of type <code class="docutils literal notranslate"><span class="pre">MySubclass</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MySubclass</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span> <span class="k">pass</span>

<span class="k">def</span> <span class="nf">enc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">MySubclass</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span>


<span class="n">f</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span><span class="n">dec</span><span class="p">)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># t is of type MySubclass</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">MySubclass</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># the output of decode is cast to MySubclass to match the input type.</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="apply-transforms-on-subsets-with-split-idx">
<h4>Apply Transforms On Subsets With <code class="docutils literal notranslate"><span class="pre">split_idx</span></code><a class="headerlink" href="#apply-transforms-on-subsets-with-split-idx" title="Permalink to this headline">¶</a></h4>
<p>You can apply transformations to subsets of data by specifying a <code class="docutils literal notranslate"><span class="pre">split_idx</span></code> property. If a transform has a <code class="docutils literal notranslate"><span class="pre">split_idx</span></code> then it’s only applied if the <code class="docutils literal notranslate"><span class="pre">split_idx</span></code> param matches.  In the below example, we set <code class="docutils literal notranslate"><span class="pre">split_idx</span></code> equal to <code class="docutils literal notranslate"><span class="pre">1</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">enc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span>
<span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">(</span><span class="n">enc</span><span class="p">,</span><span class="n">dec</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">split_idx</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p>The transformations are applied when a matching <code class="docutils literal notranslate"><span class="pre">split_idx</span></code> parameter is passed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>On the other hand, transformations are ignored when the <code class="docutils literal notranslate"><span class="pre">split_idx</span></code> parameter does not match:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="transforms-on-lists">
<h4>Transforms on Lists<a class="headerlink" href="#transforms-on-lists" title="Permalink to this headline">¶</a></h4>
<p>Transform operates on lists as a whole, <strong>not element-wise</strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    
<span class="n">f</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">_inp</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)]</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">_inp</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_inp</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decodes</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">_inp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#hide</span>
<span class="n">f</span><span class="o">.</span><span class="n">split_idx</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">_inp</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_inp</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">_inp</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">_inp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If you want a transform to operate on a list elementwise, you must implement this appropriately in the <code>encodes</code> and <code>decodes</code> methods:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AL</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span> <span class="k">pass</span>

<span class="nd">@AL</span>
<span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="n">x_</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

<span class="nd">@AL</span>
<span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="p">[</span><span class="n">x_</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">x_</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">AL</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">f</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="transforms-on-tuples">
<h4>Transforms on Tuples<a class="headerlink" href="#transforms-on-tuples" title="Permalink to this headline">¶</a></h4>
<p>Unlike lists, <code class="docutils literal notranslate"><span class="pre">Transform</span></code> operates on tuples element-wise.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">neg_int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="o">-</span><span class="n">x</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">(</span><span class="n">neg_int</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Transforms will also apply <code class="docutils literal notranslate"><span class="pre">TypedDispatch</span></code> element-wise on tuples when an input type annotation is specified.  In the below example, the values <code class="docutils literal notranslate"><span class="pre">1.0</span></code> and <code class="docutils literal notranslate"><span class="pre">3.0</span></code> are ignored because they are of type <code class="docutils literal notranslate"><span class="pre">float</span></code>, not <code class="docutils literal notranslate"><span class="pre">int</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">neg_int</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span> <span class="k">return</span> <span class="o">-</span><span class="n">x</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">(</span><span class="n">neg_int</span><span class="p">)</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">((</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)),</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#hide</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">((</span><span class="mf">1.</span><span class="p">,)),</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">input_types</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Another example of how <code class="docutils literal notranslate"><span class="pre">Transform</span></code> can use <code class="docutils literal notranslate"><span class="pre">TypedDispatch</span></code> with tuples is shown below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span> <span class="k">pass</span>

<span class="nd">@B</span>
<span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span>

<span class="nd">@B</span>
<span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="s1">&#39;hello&#39;</span>

<span class="nd">@B</span>
<span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;!&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>If the input is not an <code class="docutils literal notranslate"><span class="pre">int</span></code> or <code class="docutils literal notranslate"><span class="pre">str</span></code>, the third <code class="docutils literal notranslate"><span class="pre">encodes</span></code> method will apply:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">b</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;[1]!&#39;</span><span class="p">)</span> 
<span class="n">test_eq</span><span class="p">(</span><span class="n">b</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]),</span> <span class="s1">&#39;[1.0]!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>However, if the input is a tuple, then the appropriate method will apply according to the type of each element in the tuple:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">b</span><span class="p">((</span><span class="s1">&#39;1&#39;</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;1hello&#39;</span><span class="p">,))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">b</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">b</span><span class="p">((</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;ahello&#39;</span><span class="p">,</span><span class="s1">&#39;1.0!&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#hide</span>
<span class="nd">@B</span>
<span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span>

<span class="n">test_eq</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">((</span><span class="mi">2</span><span class="p">,)),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">decode</span><span class="p">((</span><span class="s1">&#39;2&#39;</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,))</span>
<span class="k">assert</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Dispatching over tuples works recursively, by the way:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="s1">&#39;_hello&#39;</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_hello&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">))</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.</span><span class="p">,(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;3_hello&#39;</span><span class="p">)))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Dispatching also works with <code class="docutils literal notranslate"><span class="pre">typing</span></code> module type classes, like <code class="docutils literal notranslate"><span class="pre">numbers.integral</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Transform</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">f</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">class</span> <span class="nc">InplaceTransform</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="s2">&quot;A `Transform` that modifies in-place and just returns whatever it&#39;s passed&quot;</span>
    <span class="k">def</span> <span class="nf">_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">split_idx</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#hide</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">InplaceTransform</span><span class="p">):</span> <span class="k">pass</span>

<span class="nd">@A</span>
<span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span> <span class="n">x</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
<span class="n">f</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>

<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="kc">None</span><span class="p">])),</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span> <span class="c1">#fillna fills with floats.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># export</span>
<span class="k">class</span> <span class="nc">DisplayedTransform</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="s2">&quot;A transform with a `__repr__` that shows its attrs&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> -- </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;__stored_args__&#39;</span><span class="p">,{})</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Transforms normally are represented by just their class name and a list of encodes and decodes implementations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span> <span class="n">encodes</span><span class="p">,</span><span class="n">decodes</span> <span class="o">=</span> <span class="n">noop</span><span class="p">,</span><span class="n">noop</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">f</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>A:
encodes: (object,object) -&gt; noop
decodes: (object,object) -&gt; noop
</pre></div>
</div>
</div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">DisplayedTransform</span></code> will in addition show the contents of all attributes listed in the comma-delimited string <code class="docutils literal notranslate"><span class="pre">self.store_attrs</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">DisplayedTransform</span><span class="p">):</span>
    <span class="n">encodes</span> <span class="o">=</span> <span class="n">noop</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">store_attr</span><span class="p">()</span>
    
<span class="n">A</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>A -- {&#39;a&#39;: 1, &#39;b&#39;: 2}:
encodes: (object,object) -&gt; noop
decodes: 
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="itemtransform">
<h4>ItemTransform -<a class="headerlink" href="#itemtransform" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">class</span> <span class="nc">ItemTransform</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="s2">&quot;A transform that always take tuples as items&quot;</span>
    <span class="n">_retain</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>   <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;decode&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_call1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_tuple</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(),</span> <span class="n">name</span><span class="p">)(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">super</span><span class="p">(),</span> <span class="n">name</span><span class="p">)(</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_retain</span><span class="p">:</span> <span class="k">return</span> <span class="n">y</span>
        <span class="k">if</span> <span class="n">is_listy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retain_type</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ItemTransform</span></code> is the class to use to opt out of the default behavior of <code class="docutils literal notranslate"><span class="pre">Transform</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AIT</span><span class="p">(</span><span class="n">ItemTransform</span><span class="p">):</span> 
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">):</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">xy</span><span class="p">;</span> <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xy</span><span class="p">):</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">xy</span><span class="p">;</span> <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    
<span class="n">f</span> <span class="o">=</span> <span class="n">AIT</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>If you pass a special tuple subclass, the usual retain type behavior of <code class="docutils literal notranslate"><span class="pre">Transform</span></code> will keep it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_T</span><span class="p">(</span><span class="nb">tuple</span><span class="p">):</span> <span class="k">pass</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">_T</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">_T</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#hide</span>
<span class="n">f</span><span class="o">.</span><span class="n">split_idx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">split_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">split_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#hide</span>
<span class="k">class</span> <span class="nc">Get</span><span class="p">(</span><span class="n">ItemTransform</span><span class="p">):</span>
    <span class="n">_retain</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
<span class="n">g</span> <span class="o">=</span> <span class="n">Get</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">g</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">g</span><span class="p">(([</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">])),</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#hide</span>
<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">ItemTransform</span><span class="p">):</span> 
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">_T</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">_T</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
<span class="n">f</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))),</span> <span class="n">_T</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="func">
<h3>Func -<a class="headerlink" href="#func" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">def</span> <span class="nf">get_func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="s2">&quot;Get the `t.name` (potentially partial-ized with `args` and `kwargs`) or `noop` if not defined&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">noop</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">)</span> <span class="k">else</span> <span class="n">partial</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This works for any kind of <code class="docutils literal notranslate"><span class="pre">t</span></code> supporting <code class="docutils literal notranslate"><span class="pre">getattr</span></code>, so a class or a module.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">get_func</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="s1">&#39;neg&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)(),</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">get_func</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">neg</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">)(</span><span class="mi">2</span><span class="p">),</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">get_func</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="s1">&#39;foobar&#39;</span><span class="p">)([</span><span class="mi">2</span><span class="p">]),</span> <span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">get_func</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="s1">&#39;sort&#39;</span><span class="p">)(</span><span class="n">a</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Transforms are built with multiple-dispatch: a given function can have several methods depending on the type of the object received. This is done directly with the <code class="docutils literal notranslate"><span class="pre">TypeDispatch</span></code> module and type-annotation in <code class="docutils literal notranslate"><span class="pre">Transform</span></code>, but you can also use the following class.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">class</span> <span class="nc">Func</span><span class="p">():</span>
    <span class="s2">&quot;Basic wrapper around a `name` with `args` and `kwargs` to call on a given type&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">kwargs</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;sig: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="k">return</span> <span class="n">get_func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">t</span><span class="p">):</span> <span class="k">return</span> <span class="n">mapped</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>You can call the <code class="docutils literal notranslate"><span class="pre">Func</span></code> object on any module name or type, even a list of types. It will return the corresponding function (with a default to <code class="docutils literal notranslate"><span class="pre">noop</span></code> if nothing is found) or list of functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">Func</span><span class="p">(</span><span class="s1">&#39;sqrt&#39;</span><span class="p">)(</span><span class="n">math</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">class</span> <span class="nc">_Sig</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="k">return</span> <span class="n">Func</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_inner</span>

<span class="n">Sig</span> <span class="o">=</span> <span class="n">_Sig</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">show_doc</span><span class="p">(</span><span class="n">Sig</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Sig&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<h4 id="Sig" class="doc_header"><code>Sig</code><a href="__main__.py#L4" class="source_link" style="float:right">[source]</a></h4>
<blockquote>
<div><p><code>Sig</code>(<strong>*<code class="docutils literal notranslate"><span class="pre">args</span></code></strong>, <strong>**<code class="docutils literal notranslate"><span class="pre">kwargs</span></code></strong>)</p>
</div></blockquote>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Sig</span></code> is just sugar-syntax to create a <code class="docutils literal notranslate"><span class="pre">Func</span></code> object more easily with the syntax <code class="docutils literal notranslate"><span class="pre">Sig.name(*args,</span> <span class="pre">**kwargs)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">Sig</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">math</span><span class="p">),</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="pipeline">
<h2>Pipeline -<a class="headerlink" href="#pipeline" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">def</span> <span class="nf">compose_tfms</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">tfms</span><span class="p">,</span> <span class="n">is_enc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="s2">&quot;Apply all `func_nm` attribute of `tfms` on `x`, maybe in `reverse` order&quot;</span>
    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span> <span class="n">tfms</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">tfms</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tfms</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_enc</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">decode</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">to_int</span>  <span class="p">(</span><span class="n">x</span><span class="p">):</span>   <span class="k">return</span> <span class="n">Int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">to_float</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>   <span class="k">return</span> <span class="n">Float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">double</span>  <span class="p">(</span><span class="n">x</span><span class="p">):</span>   <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span>
<span class="k">def</span> <span class="nf">half</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-&gt;</span><span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">x</span><span class="o">/</span><span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_compose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">fs</span><span class="p">):</span> <span class="n">test_eq_type</span><span class="p">(</span><span class="n">compose_tfms</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="n">Transform</span><span class="p">,</span><span class="n">fs</span><span class="p">)),</span> <span class="n">b</span><span class="p">)</span>

<span class="n">test_compose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>   <span class="n">Int</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>   <span class="n">to_int</span><span class="p">)</span>
<span class="n">test_compose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>   <span class="n">Float</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">to_int</span><span class="p">,</span><span class="n">to_float</span><span class="p">)</span>
<span class="n">test_compose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>   <span class="n">Float</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">to_int</span><span class="p">,</span><span class="n">to_float</span><span class="p">,</span><span class="n">double</span><span class="p">)</span>
<span class="n">test_compose</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span>      <span class="n">to_int</span><span class="p">,</span><span class="n">double</span><span class="p">,</span><span class="n">half</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">float</span><span class="p">):</span>  <span class="k">return</span> <span class="n">Float</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span>
    
<span class="n">tfms</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">(),</span> <span class="n">Transform</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)]</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">compose_tfms</span><span class="p">(</span><span class="mf">3.</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="n">tfms</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Float</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">compose_tfms</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="n">tfms</span><span class="p">,</span> <span class="n">is_enc</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mf">1.</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">compose_tfms</span><span class="p">(</span><span class="mf">4.</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="n">tfms</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="mf">3.</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tfms</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">(),</span> <span class="n">Transform</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)]</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">compose_tfms</span><span class="p">((</span><span class="mi">9</span><span class="p">,</span><span class="mf">3.</span><span class="p">),</span> <span class="n">tfms</span><span class="o">=</span><span class="n">tfms</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mf">2.</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">def</span> <span class="nf">mk_transform</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="s2">&quot;Convert function `f` to `Transform` if it isn&#39;t already one&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">instantiate</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,(</span><span class="n">Transform</span><span class="p">,</span><span class="n">Pipeline</span><span class="p">))</span> <span class="k">else</span> <span class="n">Transform</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">def</span> <span class="nf">gather_attrs</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nm</span><span class="p">):</span>
    <span class="s2">&quot;Used in __getattr__ to collect all attrs `k` from `self.</span><span class="si">{nm}</span><span class="s2">`&quot;</span>
    <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">k</span><span class="o">==</span><span class="n">nm</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">att</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">nm</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">att</span><span class="o">.</span><span class="n">attrgot</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">L</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">def</span> <span class="nf">gather_attr_names</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">nm</span><span class="p">):</span>
    <span class="s2">&quot;Used in __dir__ to collect all attrs `k` from `self.</span><span class="si">{nm}</span><span class="s2">`&quot;</span>
    <span class="k">return</span> <span class="n">L</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">nm</span><span class="p">))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span><span class="o">.</span><span class="n">concat</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#export</span>
<span class="k">class</span> <span class="nc">Pipeline</span><span class="p">:</span>
    <span class="s2">&quot;A pipeline of composed (for encode/decode) transforms, setup with types&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">funcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_idx</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">split_idx</span><span class="p">,</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">funcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">funcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span> <span class="n">Pipeline</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">funcs</span><span class="o">.</span><span class="n">fs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span> <span class="n">Transform</span><span class="p">):</span> <span class="n">funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">funcs</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">ifnone</span><span class="p">(</span><span class="n">funcs</span><span class="p">,[</span><span class="n">noop</span><span class="p">]))</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mk_transform</span><span class="p">)</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;order&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">camel2snake</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">+</span><span class="n">f</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train_setup</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">tfms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tfms</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">items</span><span class="p">,</span> <span class="n">train_setup</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">t</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">train_setup</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">t</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">train_setup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">compose_tfms</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_idx</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Pipeline: </span><span class="si">{</span><span class="s1">&#39; -&gt; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;noop&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">):</span> <span class="k">return</span> <span class="n">gather_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">()</span> <span class="o">+</span> <span class="n">gather_attr_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decode</span>  <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">full</span><span class="p">:</span> <span class="k">return</span> <span class="n">compose_tfms</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">tfms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span> <span class="n">is_enc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_idx</span><span class="p">)</span>
        <span class="c1">#Not full means we decode up to the point the item knows how to show itself.</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_showable</span><span class="p">(</span><span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="n">o</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">split_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">o</span>

    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">o1</span> <span class="o">=</span> <span class="p">(</span><span class="n">o</span><span class="p">,)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_tuple</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">else</span> <span class="n">o</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">):</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">o_</span> <span class="ow">in</span> <span class="n">o1</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">o_</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">):</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">o_</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>

    <span class="k">def</span> <span class="nf">_is_showable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">_is_tuple</span><span class="p">(</span><span class="n">o</span><span class="p">):</span> <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">o_</span><span class="p">,</span> <span class="s1">&#39;show&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">o_</span> <span class="ow">in</span> <span class="n">o</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add_docs</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">,</span>
         <span class="fm">__call__</span><span class="o">=</span><span class="s2">&quot;Compose `__call__` of all `fs` on `o`&quot;</span><span class="p">,</span>
         <span class="n">decode</span><span class="o">=</span><span class="s2">&quot;Compose `decode` of all `fs` on `o`&quot;</span><span class="p">,</span>
         <span class="n">show</span><span class="o">=</span><span class="s2">&quot;Show `o`, a single item from a tuple, decoding as needed&quot;</span><span class="p">,</span>
         <span class="n">add</span><span class="o">=</span><span class="s2">&quot;Add transform `t`&quot;</span><span class="p">,</span>
         <span class="n">setup</span><span class="o">=</span><span class="s2">&quot;Call each tfm&#39;s `setup` in order&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> is a wrapper for <code class="docutils literal notranslate"><span class="pre">compose_tfm</span></code>. You can pass instances of <code class="docutils literal notranslate"><span class="pre">Transform</span></code> or regular functions in <code class="docutils literal notranslate"><span class="pre">funcs</span></code>, the <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> will wrap them all in <code class="docutils literal notranslate"><span class="pre">Transform</span></code> (and instantiate them if needed) during the initialization. It handles the transform <code class="docutils literal notranslate"><span class="pre">setup</span></code> by adding them one at a time and calling setup on each, goes through them in order in <code class="docutils literal notranslate"><span class="pre">__call__</span></code> or <code class="docutils literal notranslate"><span class="pre">decode</span></code> and can <code class="docutils literal notranslate"><span class="pre">show</span></code> an object by applying decoding the transforms up until the point it gets an object that knows how to show itself.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Empty pipeline is noop</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">pipe</span><span class="p">((</span><span class="mi">1</span><span class="p">,)),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))</span>
<span class="c1"># Check pickle works</span>
<span class="k">assert</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">IntFloatTfm</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="k">return</span> <span class="n">Int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="k">return</span> <span class="n">Float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">foo</span><span class="o">=</span><span class="mi">1</span>

<span class="n">int_tfm</span><span class="o">=</span><span class="n">IntFloatTfm</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">neg</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="o">-</span><span class="n">x</span>
<span class="n">neg_tfm</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">(</span><span class="n">neg</span><span class="p">,</span> <span class="n">neg</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span><span class="n">neg_tfm</span><span class="p">,</span> <span class="n">int_tfm</span><span class="p">])</span>

<span class="n">start</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Int</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">Float</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="n">pipe</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="s1">&#39;-2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span><span class="n">neg_tfm</span><span class="p">,</span> <span class="n">int_tfm</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="n">pipe</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">pipe</span><span class="p">((</span><span class="mf">1.</span><span class="p">,</span><span class="mf">2.</span><span class="p">))),</span> <span class="s1">&#39;-1</span><span class="se">\n</span><span class="s1">-2&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">assert</span> <span class="s1">&#39;foo&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
<span class="k">assert</span> <span class="s1">&#39;int_float_tfm&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Transforms are available as attributes named with the snake_case version of the names of their types. Attributes in transforms can be directly accessed as attributes of the pipeline.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">int_float_tfm</span><span class="p">,</span> <span class="n">int_tfm</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span><span class="n">int_tfm</span><span class="p">,</span> <span class="n">int_tfm</span><span class="p">])</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">int_float_tfm</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">int_float_tfm</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">int_tfm</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">foo</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check opposite order</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span><span class="n">int_tfm</span><span class="p">,</span><span class="n">neg_tfm</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="n">pipe</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="s1">&#39;-2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">Transform</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">encodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="k">return</span> <span class="n">Float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span><span class="n">neg_tfm</span><span class="p">,</span> <span class="n">A</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">Float</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="n">pipe</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="s1">&#39;-2.0&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span><span class="n">neg_tfm</span><span class="p">,</span> <span class="n">A</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
<span class="n">test_eq_type</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="p">(</span><span class="n">Float</span><span class="p">(</span><span class="mf">1.</span><span class="p">),</span><span class="n">Float</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
<span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span><span class="n">pipe</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="s1">&#39;-1.0</span><span class="se">\n</span><span class="s1">-2.0&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="k">class</span> <span class="nc">ArrayImage</span><span class="p">(</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="n">_show_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cmap&#39;</span><span class="p">:</span><span class="s1">&#39;viridis&#39;</span><span class="p">}</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nb">tuple</span><span class="p">):</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unknown array init args&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ndarray</span><span class="p">):</span> <span class="n">x</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ctx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">_</span><span class="p">,</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_show_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">})</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>
    
<span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">TEST_IMAGE</span><span class="p">)</span>
<span class="n">im_t</span> <span class="o">=</span> <span class="n">ArrayImage</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f1</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="n">ArrayImage</span><span class="p">):</span> <span class="k">return</span> <span class="o">-</span><span class="n">x</span>
<span class="k">def</span> <span class="nf">f2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">f3</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">ArrayImage</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span><span class="n">f2</span><span class="p">,</span><span class="n">f3</span><span class="p">,</span><span class="n">f1</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">(</span><span class="n">TEST_IMAGE</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">ArrayImage</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">-</span><span class="n">array</span><span class="p">(</span><span class="n">f3</span><span class="p">(</span><span class="n">f2</span><span class="p">(</span><span class="n">TEST_IMAGE</span><span class="p">))))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span><span class="n">f2</span><span class="p">,</span><span class="n">f3</span><span class="p">])</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">(</span><span class="n">TEST_IMAGE</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/05_transform_141_0.png" src="_images/05_transform_141_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_fig_exists</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#Check filtering is properly applied</span>
<span class="n">add1</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="n">add1</span><span class="o">.</span><span class="n">split_idx</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span><span class="n">neg_tfm</span><span class="p">,</span> <span class="n">A</span><span class="p">(),</span> <span class="n">add1</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">split_idx</span><span class="o">=</span><span class="mi">1</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">pipe</span><span class="o">.</span><span class="n">split_idx</span><span class="o">=</span><span class="mi">0</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
    <span class="n">pipe</span><span class="o">.</span><span class="n">split_idx</span><span class="o">=</span><span class="n">t</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">pipe</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">start</span><span class="p">)),</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">test_stdout</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">pipe</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">pipe</span><span class="p">(</span><span class="n">start</span><span class="p">)),</span> <span class="s2">&quot;-2.0&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">neg</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="o">-</span><span class="n">x</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">mk_transform</span><span class="p">(</span><span class="n">neg</span><span class="p">)),</span> <span class="n">Transform</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">mk_transform</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)),</span> <span class="n">Transform</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">mk_transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span><span class="n">a</span><span class="o">*</span><span class="mi">2</span><span class="p">)),</span> <span class="n">Transform</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">mk_transform</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">([</span><span class="n">neg</span><span class="p">]))),</span> <span class="n">Pipeline</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="methods">
<h3>Methods<a class="headerlink" href="#methods" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#TODO: method examples</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">show_doc</span><span class="p">(</span><span class="n">Pipeline</span><span class="o">.</span><span class="fm">__call__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<h4 id="Pipeline.__call__" class="doc_header"><code>Pipeline.__call__</code><a href="__main__.py#L26" class="source_link" style="float:right">[source]</a></h4>
<blockquote>
<div><p><code>Pipeline.<strong>call</strong></code>(<strong><code class="docutils literal notranslate"><span class="pre">o</span></code></strong>)</p>
</div></blockquote>
<p>Compose <code class="docutils literal notranslate"><span class="pre">__call__</span></code> of all <code class="docutils literal notranslate"><span class="pre">fs</span></code> on <code class="docutils literal notranslate"><span class="pre">o</span></code></p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">show_doc</span><span class="p">(</span><span class="n">Pipeline</span><span class="o">.</span><span class="n">decode</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<h4 id="Pipeline.decode" class="doc_header"><code>Pipeline.decode</code><a href="__main__.py#L33" class="source_link" style="float:right">[source]</a></h4>
<blockquote>
<div><p><code>Pipeline.decode</code>(<strong><code class="docutils literal notranslate"><span class="pre">o</span></code></strong>, <strong><code class="docutils literal notranslate"><span class="pre">full</span></code></strong>=<em><code class="docutils literal notranslate"><span class="pre">True</span></code></em>)</p>
</div></blockquote>
<p>Compose <code class="docutils literal notranslate"><span class="pre">decode</span></code> of all <code class="docutils literal notranslate"><span class="pre">fs</span></code> on <code class="docutils literal notranslate"><span class="pre">o</span></code></p>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">show_doc</span><span class="p">(</span><span class="n">Pipeline</span><span class="o">.</span><span class="n">setup</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<h4 id="Pipeline.setup" class="doc_header"><code>Pipeline.setup</code><a href="__main__.py#L17" class="source_link" style="float:right">[source]</a></h4>
<blockquote>
<div><p><code>Pipeline.setup</code>(<strong><code class="docutils literal notranslate"><span class="pre">items</span></code></strong>=<em><code class="docutils literal notranslate"><span class="pre">None</span></code></em>, <strong><code class="docutils literal notranslate"><span class="pre">train_setup</span></code></strong>=<em><code class="docutils literal notranslate"><span class="pre">False</span></code></em>)</p>
</div></blockquote>
<p>Call each tfm's <code class="docutils literal notranslate"><span class="pre">setup</span></code> in order</p>
</div>
</div>
<p>During the setup, the <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> starts with no transform and adds them one at a time, so that during its setup, each transform gets the items processed up to its point and not after.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#hide</span>
<span class="c1">#Test is with TfmdList</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="export">
<h2>Export -<a class="headerlink" href="#export" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#hide</span>
<span class="kn">from</span> <span class="nn">nbdev.export</span> <span class="kn">import</span> <span class="n">notebook2script</span>
<span class="n">notebook2script</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Converted 00_test.ipynb.
Converted 01_basics.ipynb.
Converted 02_foundation.ipynb.
Converted 03_xtras.ipynb.
Converted 03a_parallel.ipynb.
Converted 03b_net.ipynb.
Converted 04_dispatch.ipynb.
Converted 05_transform-Copy1.ipynb.
Converted 05_transform.ipynb.
Converted 07_meta.ipynb.
Converted 08_script.ipynb.
Converted Untitled.ipynb.
Converted Untitled1.ipynb.
Converted index.ipynb.
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Hamel Husain<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>